# TODO Triage

Ordered list of code smells and quick wins (with file/line pointers).

## Critical Fixes (Must Do)

### 1. Add Fatal Check for 0 Outputs When K>0 Inputs

**File**: `backend/tango.py:process_tango_output()`

**Location**: After line 1076

**Issue**: TANGO produces 0 outputs for N inputs, but no error is returned to UI.

**Fix**: Add fatal check that raises `ValueError` when `parsed_ok == 0 && requested > 0`.

**See**: `FAILURE_MODES.md` for full implementation.

**Priority**: 游댮 CRITICAL

---

### 2. Surface Fatal Error to UI

**File**: `backend/server.py:upload_csv()` and `execute_uniprot_query()`

**Location**: Around line 470 (upload_csv) and line 1331 (execute_uniprot_query)

**Issue**: Fatal errors from `process_tango_output()` are caught but not surfaced to UI.

**Fix**: Catch `ValueError` with "TANGO produced 0 outputs" message and raise `HTTPException(500)` with error details.

**See**: `FAILURE_MODES.md` for full implementation.

**Priority**: 游댮 CRITICAL

---

### 3. Fix Docker Volume Mount to Use Absolute Path

**File**: `backend/tango.py:run_tango_docker()`

**Location**: Line 653

**Issue**: Docker volume mount uses relative path, which resolves incorrectly.

**Fix**: Use `os.path.abspath(TANGO_DIR)` for volume mount.

**See**: `FAILURE_MODES.md` for full implementation.

**Priority**: 游 HIGH

---

## Code Smells

### 4. Misleading Function Name: `_write_simple_bat()`

**File**: `backend/tango.py:256`

**Issue**: Function name suggests it writes `.bat` files, but it actually writes `.sh` files.

**Fix**: Rename to `_write_simple_script()` or `_write_simple_sh()`.

**Priority**: 游리 MEDIUM

**Note**: Function already generates `.sh` files (line 312: `"Tango_run.sh"`), so this is just a naming issue.

---

### 5. Legacy `.bat` Files in Output Directories

**Files**: `backend/Tango/out/run_*/Tango_run.bat`

**Issue**: Old `.bat` files from previous runs are still present.

**Fix**: Clean up old `.bat` files (they're not used anymore).

**Priority**: 游릭 LOW

**Note**: These are old outputs, not generated by current code.

---

### 6. Missing Logging for Runner Selection

**File**: `backend/tango.py:run_tango_simple()`

**Location**: After line 302

**Issue**: No logging for which runner is selected and why.

**Fix**: Add `log_info("tango_runner_selected", ...)` with runner type and selection reason.

**See**: `OBSERVABILITY.md` for full implementation.

**Priority**: 游리 MEDIUM

---

### 7. Missing Logging for Resolved Paths

**File**: `backend/tango.py:run_tango_simple()`

**Location**: After line 319

**Issue**: Paths are only logged in error cases.

**Fix**: Add `log_info("tango_paths_resolved", ...)` with all resolved paths.

**See**: `OBSERVABILITY.md` for full implementation.

**Priority**: 游리 MEDIUM

---

### 8. Missing Logging for Output File Counts

**File**: `backend/tango.py:run_tango_simple()` and `process_tango_output()`

**Location**: After execution (line 462) and after parsing (line 1032)

**Issue**: Output file counts are not logged before parsing.

**Fix**: Add `log_info("tango_outputs_counted", ...)` with file counts.

**See**: `OBSERVABILITY.md` for full implementation.

**Priority**: 游리 MEDIUM

---

### 9. Missing Logging for Empty/Unparseable Files

**File**: `backend/tango.py:__get_peptide_tango_result()`

**Location**: Lines 751-825

**Issue**: Parser returns `None` for empty files, but doesn't log why.

**Fix**: Add `log_warning("tango_file_empty", ...)` and `log_warning("tango_file_unparseable", ...)`.

**See**: `FAILURE_MODES.md` for full implementation.

**Priority**: 游리 MEDIUM

---

### 10. Missing Permission Checks for Runtime Directories

**File**: `backend/tango.py:_ensure_dirs()`

**Location**: Lines 61-64

**Issue**: Directories are created but not checked for write permissions.

**Fix**: Add permission checks and raise `RuntimeError` if not writable.

**See**: `FAILURE_MODES.md` for full implementation.

**Priority**: 游리 MEDIUM

---

### 11. Missing Configurable Timeout

**File**: `backend/tango.py:run_tango_simple()`

**Location**: Line 424

**Issue**: Timeout is hardcoded to 3600 seconds.

**Fix**: Add `TANGO_TIMEOUT_SECONDS` environment variable.

**See**: `FAILURE_MODES.md` for full implementation.

**Priority**: 游릭 LOW

---

### 12. Enhance Binary Resolution with Better Error Messages

**File**: `backend/tango.py:_resolve_tango_bin()`

**Location**: Lines 139-154

**Issue**: Error message doesn't list all checked paths.

**Fix**: Raise `RuntimeError` with list of all checked paths.

**See**: `FAILURE_MODES.md` for full implementation.

**Priority**: 游릭 LOW

---

## Quick Wins

### 13. Add Logging for Quarantine Removal

**File**: `backend/tango.py:run_tango_simple()`

**Location**: Lines 401-407

**Issue**: Quarantine removal is silent.

**Fix**: Add `log_info("tango_quarantine_removed", ...)` when successful.

**Priority**: 游릭 LOW

---

### 14. Add Logging for Script Generation

**File**: `backend/tango.py:_write_simple_bat()`

**Location**: After line 285

**Issue**: Script generation is not logged.

**Fix**: Add `log_info("tango_script_generated", ...)` with script path and binary path.

**Priority**: 游릭 LOW

---

### 15. Clean Up Old `.bat` Files

**Files**: `backend/Tango/out/run_*/Tango_run.bat`

**Issue**: Old `.bat` files from previous runs.

**Fix**: Add cleanup in `_start_new_run_dir()` to remove old `.bat` files.

**Priority**: 游릭 LOW

---

## Summary by Priority

### 游댮 CRITICAL (Must Fix)
1. Add fatal check for 0 outputs when K>0 inputs
2. Surface fatal error to UI

### 游 HIGH (Should Fix)
3. Fix Docker volume mount to use absolute path

### 游리 MEDIUM (Nice to Have)
4. Rename `_write_simple_bat()` to `_write_simple_script()`
6. Add logging for runner selection
7. Add logging for resolved paths
8. Add logging for output file counts
9. Add logging for empty/unparseable files
10. Add permission checks for runtime directories

### 游릭 LOW (Optional)
5. Clean up old `.bat` files
11. Add configurable timeout
12. Enhance binary resolution error messages
13. Add logging for quarantine removal
14. Add logging for script generation
15. Clean up old `.bat` files

---

## Implementation Order

1. **Week 1**: Critical fixes (items 1-2)
2. **Week 2**: High priority (item 3)
3. **Week 3**: Medium priority (items 4, 6-10)
4. **Week 4**: Low priority (items 11-15)

---

## File/Line Pointers

| Item | File | Line(s) | Description |
|------|------|---------|-------------|
| 1 | `backend/tango.py` | 1076 | Add fatal check |
| 2 | `backend/server.py` | 470, 1331 | Surface error to UI |
| 3 | `backend/tango.py` | 653 | Docker volume mount |
| 4 | `backend/tango.py` | 256 | Function name |
| 5 | `backend/Tango/out/run_*/` | - | Old `.bat` files |
| 6 | `backend/tango.py` | 302 | Runner selection logging |
| 7 | `backend/tango.py` | 319 | Path resolution logging |
| 8 | `backend/tango.py` | 462, 1032 | Output counts logging |
| 9 | `backend/tango.py` | 751-825 | Empty file logging |
| 10 | `backend/tango.py` | 61-64 | Permission checks |
| 11 | `backend/tango.py` | 424 | Configurable timeout |
| 12 | `backend/tango.py` | 139-154 | Binary resolution errors |
| 13 | `backend/tango.py` | 401-407 | Quarantine logging |
| 14 | `backend/tango.py` | 285 | Script generation logging |
| 15 | `backend/tango.py` | 70-90 | Cleanup old `.bat` files |

